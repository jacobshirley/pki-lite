import { describe, expect, test } from 'vitest'
import { Certificate } from '../../src/x509/Certificate.js'
import { CRLDistributionPoints } from '../../src/x509/extensions/CRLDistributionPoints.js'
import { rsaSigningKeys } from '../../test-fixtures/signing-keys/rsa-2048/index.js'
import http from 'http'
import assert from 'assert'

describe('CRL (Certificate Revocation List)', () => {
    test('can retrieve a CRL from a certificate with a CRL Distribution Point', async () => {
        const server = http
            .createServer((req, res) => {
                res.writeHead(200, { 'Content-Type': 'application/pkix-crl' })
                res.end(rsaSigningKeys.caCrl)
                server.close()
            })
            .listen(0)

        const certificate = Certificate.fromPem(rsaSigningKeys.certPem)
        const crlDps = certificate.tbsCertificate.getExtensionsByName(
            'CRL_DISTRIBUTION_POINTS',
        )

        expect(
            crlDps[0].extnValue
                .parseAs(CRLDistributionPoints)[0]
                .distributionPoint?.[0].toHumanString(),
        ).toBe('http://localhost:8080/ca.crl')

        // NB: This will only work if the CRL distribution point is accessible
        const crl = await certificate.requestCrl({
            crlDistributionPointUrls: [
                'http://localhost:' +
                    (server.address() as any).port +
                    '/ca.crl',
            ],
        })
        assert(crl, 'No CRL found')
        expect(crl.toString()).toMatchInlineSnapshot(`
          "[CertificateList] SEQUENCE :
            SEQUENCE :
              INTEGER : 1
              SEQUENCE :
                OBJECT IDENTIFIER : 1.2.840.113549.1.1.11
                NULL
              SEQUENCE :
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.6
                    PrintableString : 'US'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.8
                    UTF8String : 'Test'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.7
                    UTF8String : 'Local'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.10
                    UTF8String : 'MyOrg'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.11
                    UTF8String : 'CA'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.3
                    UTF8String : 'MyRootCA'
              UTCTime : 2025-10-01T19:05:30.000Z
              UTCTime : 2025-10-31T19:05:30.000Z
              [0] :
                SEQUENCE :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.29.20
                    OCTET STRING : 020101
            SEQUENCE :
              OBJECT IDENTIFIER : 1.2.840.113549.1.1.11
              NULL
            BIT STRING : 0111000111000100011111011111001001000000011100100000100110111101000010111011000011000100100000110100100110101000000111110010110110110010100101011111111110000010111010101000110010110001010010011110000010110001111111101101111111010001001111000011100001100011111111000110011001100111010110000101101100000101011100100001000010110011100001011011001000100001000010100101001001100111010111011001010001000011110110001110001101011011000110110100110010101111010101110100111111100111000011111100011010010011111100001010001001100100110110010110110100110110011001011111011110110011011001010111001001111110001001011111110001010010000100111000011000110001001000010100101010010001010101010111111000111010010001100111111110110001111010110110110100110000111101111101110010001110010001100110000011000001100010001010111000111100101100011111111100101101010010101000000010000111110011000100011010101110011011010001100100100011110110001001000010101100000110000110000010010011001110000001100111011101011100011001111011011011111100101111100010011011110001000100101000110011001000000100101110111000001001110111111111100100001100011011011101010001111111001111110010110001000100010111100110010001000100011101110010001100010110110101011001001110011000001010111000010111100001000110010100000100001100010001101101000100111111001111000000110000101001000010110111101010100110110001101101110111110001100001010111100001110011101001000010010010001100001100101001101011101001010101000010110101111101101000111010000011000000111110000110000110010011011110001110000110001010000001111011000111111111010011110001110001110010101011101010000001110100100011000011111000111100011010001110000001111111101101000100101110001101100110101011110011100010110001100111000101001110100000011001101100011110000110001011000101111010001111100111110100111010101001110000111001010011111100111010100010001010101111100111100010010101110011100001110011010101011001011101110100111010111010010100110111100001010100101001111111010111001010010111000001001001100111100110110110001000000111111000100001001000110011000100010011101110111011010010110001101110011010111111100110110101101001110001111000001001110111101110001100100110000111000100011001001101101101111111111101010100011101100011110101110111101110001011111001101000000001010111001110100010100110110100101110101010111001010110001110010101100011001000110100010011000100110011000010000111111001101001101000100110111100100001010110010110001110011000011011111100101111110000111110000010011001010010010110000001000000101100000101100001111100110011100010100111111110111000110011101011101010000100111101110010101011000000101111100001101110110100001110110100000000101010111110001000010100111101001000011000001000101001011111101100011110101110100110111101101010101001110011111110000010001101001100000100110100010100111100011010111100011000001000111011110000010101111101010111101101000100011010111100110001110100110110101111000110010100101110010011011010101000011000111111000010000101100000101110000101011000101100101101010100011111100010000010010000011000110110101000111010111001001100100001111101111011000110011011101010111111001000011100011000110011111000010010000001010110011111000011100100111100101111000001000101111100001110011110100101010111101001101101010111100100111001000111001111111101110110100111100011111000011101100110110011001110001001100011100001110111100110010001010001000001111001000100010111100000110011000011011011011011110110110111110101111100110111110101110100101011111111010101010111110000000011101101001101011101111001000101100111111100101111100001110000100011110001010111100110100000100010100101101110010111110011010100110000000100010100100000101001000010010110001110010110110010101010001111111010001111001011110010111100010000011011011110100110100110000101000000001111101010111001000110100010101110001100110111001010101100001110001101101001000010100111000001110000101100001001010111010001000000101000001010101000110001001000011010011101000010110100110001100001110001001100100000110010111100000100010101001000111101110010010100001110011110101010101110111010011000001111110000101010001111100011"
        `)
    })
})
