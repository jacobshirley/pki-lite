import { describe, expect, test } from 'vitest'
import { Certificate } from '../../src/x509/Certificate.js'
import { CRLDistributionPoints } from '../../src/x509/extensions/CRLDistributionPoints.js'
import { rsaSigningKeys } from '../../test-fixtures/signing-keys/rsa-2048/index.js'
import http from 'http'
import assert from 'assert'

describe('CRL (Certificate Revocation List)', () => {
    test('can retrieve a CRL from a certificate with a CRL Distribution Point', async () => {
        const server = http
            .createServer((req, res) => {
                res.writeHead(200, { 'Content-Type': 'application/pkix-crl' })
                res.end(rsaSigningKeys.caCrl)
                server.close()
            })
            .listen(0)

        const certificate = Certificate.fromPem(rsaSigningKeys.certPem)
        const crlDps = certificate.tbsCertificate.getExtensionsByName(
            'CRL_DISTRIBUTION_POINTS',
        )

        expect(
            crlDps[0].extnValue
                .parseAs(CRLDistributionPoints)[0]
                .distributionPoint?.[0].toHumanString(),
        ).toBe('http://localhost:8080/ca.crl')

        // NB: This will only work if the CRL distribution point is accessible
        const crl = await certificate.requestCrl({
          crlDistributionPointUrls: ['http://localhost:' + (server.address() as any).port + '/ca.crl'],
        })
        assert(crl, 'No CRL found')
        expect(crl.toString()).toMatchInlineSnapshot(`
          "[CertificateList] SEQUENCE :
            SEQUENCE :
              INTEGER : 1
              SEQUENCE :
                OBJECT IDENTIFIER : 1.2.840.113549.1.1.11
                NULL
              SEQUENCE :
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.6
                    PrintableString : 'US'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.8
                    UTF8String : 'Test'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.7
                    UTF8String : 'Local'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.10
                    UTF8String : 'MyOrg'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.11
                    UTF8String : 'CA'
                SET :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.4.3
                    UTF8String : 'MyRootCA'
              UTCTime : 2025-09-21T10:59:16.000Z
              UTCTime : 2025-10-21T10:59:16.000Z
              [0] :
                SEQUENCE :
                  SEQUENCE :
                    OBJECT IDENTIFIER : 2.5.29.20
                    OCTET STRING : 020101
            SEQUENCE :
              OBJECT IDENTIFIER : 1.2.840.113549.1.1.11
              NULL
            BIT STRING : 1000110000001000010100100100100101000110101010001101001100100001100100101000111111000110110111101000110111111010100101011100111001100110111001100001100011100101111110011110101000001110011000011110000110101010100000010101011111111010000101000101101011101100111000010000100111000101001000111000000111110111010011101001100100010100111111111010001110000010011001111110110001001000011010010110100101101010110110010110111000111000010111111100101101000000000000110111001000010111100100101001001100011000110001110010000110111100000111000011110010110100011110111100010000001101110010101001010000001100010101100000011011001011001101001000010111110010101000001001110011110100101000000100111001111000011001000011010100100100110010000000100001011001001111101000100001011010100111011000011010010111101000100100010001001010100011101001000011101011110001001001111100100100111001001111011100111110000100000110001011101001111100010011010110010011010111101111001000100101100100100001110111011011000010110010111000111011111101101110010101111011101001111111110000111111100101100101110001001000101111101100000111110011110110100111010101111011011101000111100101000011110000001011100000011001101111011100111101110101011100110001011010000111100110001000101010110000100101011101001011101001110001010010001110110000000100100010010101000010001100010011110001111000110000001000110011111000110010110101110100000000011101101111011101100010110110101101000111011000000000111001011101001111110010111100111101101001001011110000110011101001111011010001001101001011001100111010110000101111100001110010100001100011101010000010000100010001011110010011110011110000010100100110101010011010111000100110101000000000010001000001011001001011101011010110011110000101111001110100001010000111010001101110111011101110001001000011011101001001010110101111101110101001111010000001000101100111001111111110011011110101001010010111000010000111000001011001010010111011000110101110110010001100111000100100000001011100000100001101000111110000110110001000101110001100100010101111100101010011011101110101001001111010100100101101011001100110110100111101111111110100101001001001010000000011000010100000000100000001101001000100011101110010010011000100010110110010110110001110111100001100111011011010010000111100111111111101010000011000110111100011011100110111111001101001100001101110111101011101111010011101011001000101001001110110110000011110110101110010001001010001010011011001000110001011101010001110111111100111100011110001011011101010010011100101110100000010000001011010101011001010110010001101010100000001010101100000100000101110001001001011111010111110110011001110100100011100111110100111010111001000000101101110101001110110010100111100110101011011101001001101011101001000001101110011011010010010111101010101101001011001001000001001011000110000101010000100011001101110010111000000001010000001101011111011010010101111001000100010110000110010010111010110101000000101110010101101011100000000011001001011000111101010110110011010010011010110000110101000011011110010100110101100011100010001101010110010000011001111110000010101000000010100101101100000100110101110010110000000001000110111010101001011001111011111000110110001110111001001110100100000011100011111101101110101001001001110001001000011111001100001010110000010100011011110111010000010100011110111100111100100100011101111001101101010000010010101000110000101111110011110110111100111001111001000010010001011110110010011010101010111000111110011110110001001111110001000000111011100111011010110111000100010000100101101000110111111101001000110010001011110111100010001000111010110101001000010101100101110011110011010000000110100010110000000100010010000100100001110000000100001111001001100001011011011111110100110111000101101110010100100110110000101100111001000101010111110001000011011100110011000100000001111101100010111010001000101110111010001100101010100010101001010100100101101101101010100010000011011100100011001011000111000011011011001101111111101100000101110101010101111101100011011101001011000110111110000101111000011010100001101001001011001011100100100101101110010000000100001111000110110000010011110"
        `)
    })
})
